name: Pull Request Check

on:
  workflow_dispatch:  # allows manual triggering
  pull_request:

jobs:
  run-changed-r:
    runs-on: ubuntu-latest

    container:
      image: rocker/geospatial:latest
      options: --user root  # needed to write to /home

    steps:
    - name: Install system dependencies
      run: |
        apt-get update && apt-get install -y \
        libssl-dev \
        libcurl4-openssl-dev \
        libxml2-dev \
        libgit2-dev \
        git \
        ca-certificates \
        jq \
        curl \
        gnupg \
        lsb-release \
        apt-transport-https \
        unzip

    - name: Install Azure CLI
      run: |
        curl -sL https://aka.ms/InstallAzureCLIDeb | bash

    - name: Checkout code
      uses: actions/checkout@v3

    - name: Log in to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_SP }}

    - name: Create data directory
      run: mkdir -p /home/jovyan/carob-eia/data/raw/eia

    - name: Download source data from Azure Blob
      run: |
        az storage blob download-batch \
          --account-name kapi \
          --destination /home/jovyan/carob-eia/data/raw/eia \
          --source eia-carob-raw \
          --auth-mode login

    - name: Install remotes package
      run: Rscript -e 'install.packages("remotes")'

    - name: Install carobiner package from GitHub
      env:
        GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      run: Rscript -e 'remotes::install_github("reagro/carobiner")'

    # - name: Run review of R scripts
    #   run: |
    #     Rscript -e "source('scripts/eia/NT7VLWDrOQEkarWkfn2bDSuf.R'); carob_script()"
